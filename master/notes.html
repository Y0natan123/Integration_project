<div class="notes-container">
    <style>
        .notes-container {
            width: 100%;
            height: calc(100vh - 70px);
            background: linear-gradient(135deg, #0a0e17 0%, #1a1f3a 40%, #0a0e17 100%);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .notes-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(79, 172, 254, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(0, 242, 254, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(134, 239, 172, 0.05) 0%, transparent 60%);
            pointer-events: none;
        }
        
        .notes-header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px 30px;
            margin: 25px 25px 0 25px;
            border-radius: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .notes-header h1 {
            margin: 0;
            color: #ffffff;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(79, 172, 254, 0.3);
        }
        
        .header-subtitle {
            margin: 8px 0 0 0; 
            font-size: 14px; 
            color: rgba(255, 255, 255, 0.7); 
            font-style: italic;
        }
        
        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .filter-dropdown, .search-input {
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid rgba(79, 172, 254, 0.3);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            color: #ffffff;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-dropdown::placeholder, .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .filter-dropdown:focus, .search-input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }

        .search-input {
            width: 250px;
        }

        .filter-dropdown option {
            background: #1a1f3a;
            color: #ffffff;
        }
        
        .notes-content {
            flex: 1;
            padding: 0 25px 25px 25px;
            overflow-y: auto;
            margin-top: 25px;
            position: relative;
            z-index: 2;
        }

        /* Custom scrollbar for notes-content */
        .notes-content::-webkit-scrollbar {
            width: 8px;
        }

        .notes-content::-webkit-scrollbar-track {
            background: rgba(26, 31, 58, 0.6);
            border-radius: 10px;
        }

        .notes-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .notes-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #3d8bfe 0%, #00d4fe 100%);
            box-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
        }
        
        .tasks-section {
            margin-bottom: 40px;
        }

        .task-header {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 20px 25px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-title {
            font-size: 22px;
            font-weight: 700;
            color: #ffffff;
            margin: 0;
        }

        .task-status {
            font-size: 12px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .task-status.active {
            background: linear-gradient(135deg, #86efac 0%, #22c55e 100%);
            color: #065f46;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }
        
        .task-status.inactive {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .runs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .run-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .run-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.05) 0%, rgba(0, 242, 254, 0.03) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .run-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.4),
                0 0 25px rgba(79, 172, 254, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border-color: rgba(79, 172, 254, 0.5);
        }

        .run-card:hover::before {
            opacity: 1;
        }
        
        .run-card.current {
            border: 2px solid #22c55e;
            box-shadow: 
                0 0 0 4px rgba(34, 197, 94, 0.3),
                0 15px 35px rgba(0, 0, 0, 0.4);
            background: rgba(34, 197, 94, 0.05);
        }
        
        .run-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .run-id {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .run-name-display {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .run-name-display:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.02);
        }
        
        .run-name-display:hover::after {
            content: '‚úèÔ∏è';
            position: absolute;
            right: -15px;
            top: 0;
            font-size: 10px;
            opacity: 0.7;
        }

        .run-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .run-badge.current {
            background: linear-gradient(135deg, #86efac 0%, #22c55e 100%);
            color: #065f46;
        }

        .run-badge.historical {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
        }
        
        .run-details {
            margin-bottom: 15px;
        }
        
        .run-time {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            margin-bottom: 5px;
        }
        
        .run-measurements {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
        }
        
        .run-notes-section {
            margin-top: 10px;
            padding: 12px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .run-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .run-notes-count {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .run-notes-count i {
            color: #4facfe;
            font-size: 12px;
        }
        
        .add-note-btn {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 
                0 4px 15px rgba(79, 172, 254, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .add-note-btn:hover {
            background: linear-gradient(135deg, #3d8bfe 0%, #00d4fe 100%);
            transform: scale(1.1);
            box-shadow: 
                0 8px 20px rgba(79, 172, 254, 0.6),
                0 0 15px rgba(79, 172, 254, 0.4);
        }
        
        .graph-btn {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 
                0 4px 15px rgba(16, 185, 129, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .graph-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            transform: scale(1.1);
            box-shadow: 
                0 8px 20px rgba(16, 185, 129, 0.6),
                0 0 15px rgba(16, 185, 129, 0.4);
        }
        
        .read-notes-btn {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 
                0 4px 15px rgba(139, 92, 246, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .read-notes-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
            transform: scale(1.1);
            box-shadow: 
                0 8px 20px rgba(139, 92, 246, 0.6),
                0 0 15px rgba(139, 92, 246, 0.4);
        }
        
        .edit-name-btn {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 
                0 4px 15px rgba(245, 158, 11, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .edit-name-btn:hover {
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
            transform: scale(1.1);
            box-shadow: 
                0 8px 20px rgba(245, 158, 11, 0.6),
                0 0 15px rgba(245, 158, 11, 0.4);
        }
        
        .delete-run-btn {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 
                0 4px 15px rgba(239, 68, 68, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .delete-run-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            transform: scale(1.1);
            box-shadow: 
                0 8px 20px rgba(239, 68, 68, 0.6),
                0 0 15px rgba(239, 68, 68, 0.4);
        }
        
        .no-tasks-message, .no-runs-message {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            margin: 50px 0;
            font-size: 16px;
            font-weight: 500;
            padding: 40px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid rgba(79, 172, 254, 0.2);
            border-radius: 50%;
            border-top-color: #4facfe;
            animation: spin 1s linear infinite;
            margin: 50px auto;
            display: block;
        }
        
        /* Notes Modal Styles */
        .notes-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            overflow-y: auto;
            padding: 50px 20px;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            max-width: 800px;
            margin: 0 auto;
            padding: 30px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #ffffff;
            font-size: 24px;
            font-weight: 700;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.6);
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        /* Custom scrollbar for modal */
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 10px;
        }
        
        .note-form {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            margin-bottom: 25px;
            display: none;
        }
        
        .note-form textarea {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid rgba(79, 172, 254, 0.3);
            border-radius: 12px;
            resize: vertical;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            color: #ffffff;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .note-form textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .note-form textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }
        
        .note-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        .note-form-actions button {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .save-note-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }

        .save-note-btn:hover {
            background: linear-gradient(135deg, #3d8bfe 0%, #00d4fe 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.6);
        }
        
        .cancel-note-btn {
            background: rgba(248, 113, 113, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(248, 113, 113, 0.3);
        }

        .cancel-note-btn:hover {
            background: rgba(248, 113, 113, 0.3);
            color: #ffffff;
            transform: translateY(-2px);
        }
        
        .note-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            transition: all 0.3s ease;
        }

        .note-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            border-color: rgba(79, 172, 254, 0.3);
        }
        
        .note-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .note-date {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
        }
        
        .note-actions {
            display: flex;
            gap: 12px;
        }
        
        .note-actions button {
            border: none;
            background: none;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            padding: 6px 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .note-actions button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        .delete-note:hover {
            color: #fca5a5 !important;
            background: rgba(248, 113, 113, 0.2) !important;
        }
        
        .edit-note:hover {
            color: #4facfe !important;
            background: rgba(79, 172, 254, 0.2) !important;
        }
        
        .note-content {
            font-size: 15px;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
        
        .notification {
            padding: 16px 24px;
            margin-bottom: 12px;
            border-radius: 12px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 320px;
            max-width: 400px;
            animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .notification.success {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.4);
        }
        
        .notification.error {
            background: rgba(248, 113, 113, 0.2);
            border-color: rgba(248, 113, 113, 0.4);
        }
        
        .notification.info {
            background: rgba(79, 172, 254, 0.2);
            border-color: rgba(79, 172, 254, 0.4);
        }
        
        .close-notification {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            margin-left: 15px;
            padding: 2px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-notification:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(100%) scale(0.8); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0) scale(1); 
                opacity: 1; 
            }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .notes-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .filter-controls {
                flex-direction: column;
                width: 100%;
            }

            .search-input {
                width: 100%;
            }

            .runs-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 0 10px;
                padding: 20px;
            }
        }

        .graph-indicator {
            color: #4facfe;
            font-size: 14px;
            opacity: 0.8;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .run-card:hover .graph-indicator {
            opacity: 1;
            transform: scale(1.1);
            color: #00f2fe;
        }
    </style>
    
    <div class="notes-header">
        <div>
            <h1>Task Runs & Notes</h1>
            <p class="header-subtitle">üìä Click runs to view spectrophotometer graphs - Use + button to add notes</p>
        </div>
        <div class="filter-controls">
            <input type="text" class="search-input" id="search-runs" placeholder="Search runs...">
            <select class="filter-dropdown" id="status-filter">
                <option value="all">All Runs</option>
                <option value="current">Current Runs</option>
                <option value="historical">Historical Runs</option>
            </select>
        </div>
    </div>
    
    <div class="notes-content" id="content">
        <div class="loading-spinner"></div>
    </div>
        
    <!-- Notes Modal -->
    <div class="notes-modal" id="notes-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-run-title">Run Notes</h2>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Note form for adding/editing notes -->
                <div class="note-form" id="note-form">
                    <textarea id="note-text" placeholder="Enter your note about this run..."></textarea>
                    <div class="note-form-actions">
                        <button class="cancel-note-btn" id="cancel-note-btn">Cancel</button>
                        <button class="save-note-btn" id="save-note-btn">Save Note</button>
                    </div>
                </div>
                
                <div id="notes-list">
                    <!-- Notes will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        (function() {
            // Encapsulate all variables to avoid conflicts with master page
            let currentTaskId = null;
            let currentRunId = null;
            let currentEditingNoteId = null;
            let tasksData = [];
            
            // Load tasks and their runs when the page loads
            document.addEventListener('DOMContentLoaded', () => {
                console.log('üì± DOMContentLoaded event fired');
                loadAllData();
                setupEventListeners();
            });
            
            // Also listen for our custom event
            document.addEventListener('notesPageReady', () => {
                console.log('üì± notesPageReady event fired');
                loadAllData();
                setupEventListeners();
            });
            
            // Set up event listeners
            function setupEventListeners() {
                console.log('üîß Setting up event listeners...');
                
                // Set up event listeners
                const cancelBtn = document.getElementById('cancel-note-btn');
                const saveBtn = document.getElementById('save-note-btn');
                const closeBtn = document.getElementById('close-modal');
                const searchInput = document.getElementById('search-runs');
                const statusFilter = document.getElementById('status-filter');
                const notesModal = document.getElementById('notes-modal');
                
                if (cancelBtn) {
                    cancelBtn.removeEventListener('click', cancelNote);
                    cancelBtn.addEventListener('click', cancelNote);
                    console.log('‚úÖ Cancel button listener set');
                }
                
                if (saveBtn) {
                    saveBtn.removeEventListener('click', saveNote);
                    saveBtn.addEventListener('click', saveNote);
                    console.log('‚úÖ Save button listener set');
                }
                
                if (closeBtn) {
                    closeBtn.removeEventListener('click', closeNotesModal);
                    closeBtn.addEventListener('click', closeNotesModal);
                    console.log('‚úÖ Close button listener set');
                }
                
                if (searchInput) {
                    searchInput.removeEventListener('input', filterRuns);
                    searchInput.addEventListener('input', filterRuns);
                    console.log('‚úÖ Search input listener set');
                }
                
                if (statusFilter) {
                    statusFilter.removeEventListener('change', filterRuns);
                    statusFilter.addEventListener('change', filterRuns);
                    console.log('‚úÖ Status filter listener set');
                }
                
                if (notesModal) {
                    notesModal.removeEventListener('click', handleModalClick);
                    notesModal.addEventListener('click', handleModalClick);
                    console.log('‚úÖ Modal click listener set');
                }
            }
            
            function handleModalClick(e) {
                if (e.target === document.getElementById('notes-modal')) {
                    closeNotesModal();
                }
            }
            
            // Close the notes modal
            function closeNotesModal() {
                document.getElementById('notes-modal').style.display = 'none';
                document.getElementById('note-form').style.display = 'none';
                currentEditingNoteId = null;
            }
            
            // Load all tasks and their runs
            async function loadAllData() {
                console.log('üîÑ Starting to load all data...');
                try {
                    console.log('üì° Fetching tasks from API...');
                    const tasksResponse = await fetch('http://localhost:8000/api/tasks');
                    console.log('üì° Tasks response status:', tasksResponse.status);
                    
                    if (!tasksResponse.ok) {
                        console.error('‚ùå Tasks API failed:', tasksResponse.status, tasksResponse.statusText);
                        throw new Error(`Tasks API failed: ${tasksResponse.status}`);
                    }
                    
                    const tasks = await tasksResponse.json();
                    console.log('üìä Tasks received:', tasks);
                    
                    const content = document.getElementById('content');
                    
                    if (tasks.length === 0) {
                        console.log('‚ö†Ô∏è No tasks found');
                        content.innerHTML = '<div class="no-tasks-message">No measurement tasks available</div>';
                        return;
                    }
                    
                    content.innerHTML = '';
                    tasksData = [];
                    
                    console.log(`üîÑ Loading runs for ${tasks.length} tasks...`);
                    
                    // Load runs for each task
                    for (const task of tasks) {
                        console.log(`üì° Fetching runs for task ${task.task_id}...`);
                        try {
                            const runsResponse = await fetch(`http://localhost:8000/api/tasks/${task.task_id}/runs`);
                            console.log(`üì° Runs response for task ${task.task_id}:`, runsResponse.status);
                            
                            if (!runsResponse.ok) {
                                console.error(`‚ùå Runs API failed for task ${task.task_id}:`, runsResponse.status);
                                continue;
                            }
                            
                            const runs = await runsResponse.json();
                            console.log(`üìä Runs for task ${task.task_id}:`, runs);
                            
                            // Add note counts to runs
                            for (const run of runs) {
                                console.log(`üì° Fetching notes for task ${task.task_id}, run ${run.run_id}...`);
                                try {
                                    const notesResponse = await fetch(`http://localhost:8000/api/tasks/${task.task_id}/runs/${run.run_id}/notes`);
                                    if (notesResponse.ok) {
                                        const notes = await notesResponse.json();
                                        run.notes_count = notes.length;
                                        console.log(`üìù Task ${task.task_id}, Run ${run.run_id}: ${notes.length} notes`);
                                    } else {
                                        run.notes_count = 0;
                                        console.log(`‚ö†Ô∏è No notes for task ${task.task_id}, run ${run.run_id}`);
                                    }
                                } catch (error) {
                                    console.error(`‚ùå Error getting notes count for run ${run.run_id}:`, error);
                                    run.notes_count = 0;
                                }
                            }
                            
                            const taskData = {
                                ...task,
                                runs: runs
                            };
                            
                            tasksData.push(taskData);
                            console.log(`‚úÖ Task ${task.task_id} data prepared:`, taskData);
                            renderTaskSection(taskData);
                        } catch (error) {
                            console.error(`‚ùå Error loading runs for task ${task.task_id}:`, error);
                        }
                    }
                    
                    console.log(`üìä Final tasksData:`, tasksData);
                    
                    if (tasksData.length === 0 || tasksData.every(task => task.runs.length === 0)) {
                        console.log('‚ö†Ô∏è No runs found for any tasks');
                        content.innerHTML = '<div class="no-runs-message">No task runs available yet. Runs will appear after data collection starts.</div>';
                    } else {
                        console.log(`‚úÖ Successfully loaded ${tasksData.length} tasks with runs`);
                    }
                } catch (error) {
                    console.error('‚ùå Error loading tasks:', error);
                    document.getElementById('content').innerHTML = 
                        '<div class="no-tasks-message">Error loading measurement data</div>';
                }
            }
            
            // Render a task section with its runs
            function renderTaskSection(taskData) {
                const content = document.getElementById('content');
                
                if (taskData.runs.length === 0) {
                    return; // Don't show tasks with no runs
                }
                
                const section = document.createElement('div');
                section.className = 'tasks-section';
                section.setAttribute('data-task-id', taskData.task_id);
                
                // Task header
                const header = document.createElement('div');
                header.className = 'task-header';
                
                const title = document.createElement('h3');
                title.className = 'task-title';
                title.textContent = taskData.name || taskData.task_name || `Task ${taskData.task_id}`;
                
                const status = document.createElement('div');
                status.className = `task-status ${taskData.is_active ? 'active' : 'inactive'}`;
                status.textContent = taskData.is_active ? 'Running' : 'Stopped';
                
                header.appendChild(title);
                header.appendChild(status);
                
                // Runs grid
                const runsGrid = document.createElement('div');
                runsGrid.className = 'runs-grid';
                
                taskData.runs.forEach(run => {
                    renderRunCard(taskData, run, runsGrid);
                });
                
                section.appendChild(header);
                section.appendChild(runsGrid);
                content.appendChild(section);
            }
            
            // Render a run card
            function renderRunCard(taskData, run, container) {
                const card = document.createElement('div');
                card.className = `run-card ${taskData.is_active && run.run_id === Math.max(...taskData.runs.map(r => r.run_id)) ? 'current' : ''}`;
                card.setAttribute('data-task-id', taskData.task_id);
                card.setAttribute('data-run-id', run.run_id);
                card.setAttribute('data-task-name', taskData.name || taskData.task_name || '');
                card.setAttribute('data-run-time', run.start_time);
                card.title = `Click to view spectrophotometer graph for ${taskData.name || taskData.task_name || `Task ${taskData.task_id}`} - Run #${run.run_id}`;
                
                const header = document.createElement('div');
                header.className = 'run-header';
                
                const runId = document.createElement('div');
                runId.className = 'run-id';
                
                const isCurrent = taskData.is_active && run.run_id === Math.max(...taskData.runs.map(r => r.run_id));
                
                // Create run name span (no double-click functionality)
                const runNameSpan = document.createElement('span');
                runNameSpan.className = 'run-name-display';
                runNameSpan.textContent = getCustomRunName(taskData.task_id, run.run_id);
                
                // Remove double-click event listener - now using button instead
                
                runId.innerHTML = '';
                runId.appendChild(runNameSpan);
                runId.innerHTML += `
                    <span class="run-badge ${isCurrent ? 'current' : 'historical'}">
                        ${isCurrent ? 'Current' : 'Historical'}
                    </span>
                    <span class="graph-indicator" title="Click to view spectrophotometer graph">
                        <i class="fas fa-chart-line"></i>
                    </span>
                `;
                
                header.appendChild(runId);
                
                const details = document.createElement('div');
                details.className = 'run-details';
                
                const time = document.createElement('div');
                time.className = 'run-time';
                time.textContent = `${formatDateTime(run.start_time)}`;
                
                const measurements = document.createElement('div');
                measurements.className = 'run-measurements';
                measurements.textContent = `${run.measurement_count} measurements ‚Ä¢ ${run.min_wavelength}-${run.max_wavelength}nm`;
                
                details.appendChild(time);
                details.appendChild(measurements);
                
                const notesSection = document.createElement('div');
                notesSection.className = 'run-notes-section';
                
                const notesCount = document.createElement('div');
                notesCount.className = 'run-notes-count';
                notesCount.innerHTML = `
                    <i class="fas fa-sticky-note"></i> 
                    ${run.notes_count === 0 ? 'No notes' : 
                      run.notes_count === 1 ? '1 note' : 
                      `${run.notes_count} notes`}
                `;
                
                const addNoteBtn = document.createElement('button');
                addNoteBtn.className = 'add-note-btn';
                addNoteBtn.innerHTML = '<i class="fas fa-plus"></i>';
                addNoteBtn.title = `Add note to run #${run.run_id}`;
                addNoteBtn.onclick = (e) => {
                    e.stopPropagation();
                    openRunNotes(taskData.task_id, run.run_id, taskData.name || taskData.task_name || `Task ${taskData.task_id}`, run);
                    showNoteForm();
                };
                
                // Add read notes button
                const readNotesBtn = document.createElement('button');
                readNotesBtn.className = 'read-notes-btn';
                readNotesBtn.innerHTML = '<i class="fas fa-eye"></i>';
                readNotesBtn.title = `View notes for run #${run.run_id}`;
                readNotesBtn.onclick = (e) => {
                    e.stopPropagation();
                    openRunNotes(taskData.task_id, run.run_id, taskData.name || taskData.task_name || `Task ${taskData.task_id}`, run);
                    // Don't show the note form - just view existing notes
                };
                
                // Add edit name button
                const editNameBtn = document.createElement('button');
                editNameBtn.className = 'edit-name-btn';
                editNameBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editNameBtn.title = `Edit name for run #${run.run_id}`;
                editNameBtn.onclick = (e) => {
                    e.stopPropagation();
                    editRunName(runNameSpan, taskData.task_id, run.run_id);
                };
                
                // Add delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-run-btn';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = `Delete run #${run.run_id}`;
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteRun(taskData.task_id, run.run_id, card);
                };
                
                // Add graph button
                const graphBtn = document.createElement('button');
                graphBtn.className = 'graph-btn';
                graphBtn.innerHTML = '<i class="fas fa-chart-line"></i>';
                graphBtn.title = `View spectrophotometer graph for run #${run.run_id}`;
                graphBtn.onclick = (e) => {
                    e.stopPropagation();
                    // Check if run has data before opening graph
                    if (!run.measurements_count || run.measurements_count === 0) {
                        alert(`No measurement data available for Run #${run.run_id}`);
                        return;
                    }
                    const url = `spectro-graph.html?taskId=${taskData.task_id}&runId=${run.run_id}`;
                    window.open(url, '_blank', 'width=1400,height=900');
                };
                
                // Create button container
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'run-buttons';
                buttonContainer.appendChild(addNoteBtn);
                buttonContainer.appendChild(readNotesBtn);
                buttonContainer.appendChild(editNameBtn);
                buttonContainer.appendChild(deleteBtn);
                buttonContainer.appendChild(graphBtn);
                
                notesSection.appendChild(notesCount);
                notesSection.appendChild(buttonContainer);
                
                card.appendChild(header);
                card.appendChild(details);
                card.appendChild(notesSection);
                
                container.appendChild(card);
            }
            
            // Filter runs based on search and status
            function filterRuns() {
                const searchTerm = document.getElementById('search-runs').value.toLowerCase();
                const statusFilter = document.getElementById('status-filter').value;
                
                const runCards = document.querySelectorAll('.run-card');
                const taskSections = document.querySelectorAll('.tasks-section');
                
                runCards.forEach(card => {
                    const taskName = card.getAttribute('data-task-name').toLowerCase();
                    const runId = card.getAttribute('data-run-id');
                    const runTime = card.getAttribute('data-run-time');
                    const isCurrent = card.classList.contains('current');
                    
                    const matchesSearch = taskName.includes(searchTerm) || 
                                         runId.includes(searchTerm) || 
                                         runTime.includes(searchTerm);
                    
                    const matchesStatus = statusFilter === 'all' || 
                                         (statusFilter === 'current' && isCurrent) ||
                                         (statusFilter === 'historical' && !isCurrent);
                    
                    if (matchesSearch && matchesStatus) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
                
                // Hide task sections that have no visible runs
                taskSections.forEach(section => {
                    const visibleRuns = section.querySelectorAll('.run-card:not([style*="display: none"])');
                    if (visibleRuns.length === 0) {
                        section.style.display = 'none';
                    } else {
                        section.style.display = '';
                    }
                });
            }
            
            // Open run notes modal
            function openRunNotes(taskId, runId, taskName, runData) {
                currentTaskId = taskId;
                currentRunId = runId;
                
                const isCurrent = runData && tasksData.find(t => t.task_id === taskId)?.is_active && 
                                 runId === Math.max(...tasksData.find(t => t.task_id === taskId)?.runs.map(r => r.run_id) || []);
                
                const statusText = isCurrent ? 'üü¢ Current Run' : 'üìä Historical Run';
                
                document.getElementById('modal-run-title').innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <span>${taskName} - Run #${runId}</span>
                        <span style="font-size: 14px; opacity: 0.8;">${statusText}</span>
                        ${runData ? `<span style="font-size: 12px; opacity: 0.6;">${formatDateTime(runData.start_time)}</span>` : ''}
                    </div>
                `;
                
                document.getElementById('notes-modal').style.display = 'block';
                loadRunNotes(taskId, runId);
            }
            
            // Show the note form
            function showNoteForm() {
                document.getElementById('note-text').value = '';
                document.getElementById('note-form').style.display = 'block';
                document.getElementById('note-text').focus();
            }
            
            // Cancel adding/editing a note
            function cancelNote() {
                document.getElementById('note-form').style.display = 'none';
                currentEditingNoteId = null;
            }
            
            // Load notes for a specific run
            async function loadRunNotes(taskId, runId) {
                const notesList = document.getElementById('notes-list');
                notesList.innerHTML = '<div class="loading-spinner"></div>';
                
                try {
                    let notes = [];
                    
                    // Try server first
                    try {
                        const response = await fetch(`http://localhost:8000/api/tasks/${taskId}/runs/${runId}/notes`);
                        
                        if (response.ok) {
                            notes = await response.json();
                        } else {
                            throw new Error('Server not available');
                        }
                    } catch (serverError) {
                        console.log('Server not available, using mock data');
                        // Use mock data as fallback
                        notes = mockNotes.filter(note => 
                            note.task_id == taskId && note.run_id == runId
                        );
                    }
                    
                    if (notes.length === 0) {
                        notesList.innerHTML = '<div class="no-notes-message">No notes for this run yet. Click + to add one!</div>';
                        return;
                    }
                    
                    notesList.innerHTML = '';
                    
                    // Sort notes by date (newest first)
                    notes.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    notes.forEach(note => {
                        renderNoteCard(note);
                    });
                } catch (error) {
                    console.error('Error loading run notes:', error);
                    notesList.innerHTML = 
                        `<div class="no-notes-message error">Error loading notes: ${error.message}</div>`;
                }
            }
            
            // Render a note card
            function renderNoteCard(note) {
                const notesList = document.getElementById('notes-list');
                
                const card = document.createElement('div');
                card.className = 'note-card';
                card.setAttribute('data-note-id', note.id);
                
                const header = document.createElement('div');
                header.className = 'note-header';
                
                const date = document.createElement('div');
                date.className = 'note-date';
                date.textContent = formatDateTime(note.created_at);
                
                const actions = document.createElement('div');
                actions.className = 'note-actions';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-note';
                editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
                editBtn.onclick = () => editNote(note);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-note';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
                deleteBtn.onclick = () => deleteNote(note.id);
                
                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
                
                header.appendChild(date);
                header.appendChild(actions);
                
                const content = document.createElement('div');
                content.className = 'note-content';
                content.textContent = note.content;
                
                card.appendChild(header);
                card.appendChild(content);
                
                notesList.appendChild(card);
            }
            
            // Edit an existing note
            function editNote(note) {
                currentEditingNoteId = note.id;
                document.getElementById('note-text').value = note.content;
                document.getElementById('note-form').style.display = 'block';
                document.getElementById('note-text').focus();
            }
            
            // Format date/time for display
            function formatDateTime(dateString) {
                const date = new Date(dateString);
                return date.toLocaleString();
            }
            
            // Mock data for notes (in case server is not available)
            let mockNotes = [
                // Task 1 (Vitamin C Analysis) - Run 1
                {
                    id: 1, task_id: 1, run_id: 1,
                    content: "◊™◊ó◊ô◊ú◊™ ◊û◊ì◊ô◊ì◊™ ◊ï◊ô◊ò◊û◊ô◊ü C ◊ë◊ì◊í◊ô◊û◊™ ◊û◊ô◊• ◊™◊§◊ï◊ñ◊ô◊ù. ◊®◊ô◊õ◊ï◊ñ ◊®◊ê◊©◊ï◊†◊ô ◊û◊©◊ï◊¢◊®: 45mg/100ml",
                    created_at: "2024-01-15T09:15:00Z", author: "Dr. Rachel Cohen"
                },
                {
                    id: 2, task_id: 1, run_id: 1,
                    content: "◊©◊ô◊ê ◊ê◊ë◊°◊§◊ï◊®◊¶◊ô◊î ◊ë-265nm ◊™◊ï◊ê◊ù ◊ú◊®◊ô◊õ◊ï◊ñ ◊ï◊ô◊ò◊û◊ô◊ü C ◊©◊ú 42.3mg/100ml. ◊™◊ï◊¶◊ê◊î ◊™◊ß◊ô◊†◊î ◊ú◊§◊ô ◊î◊°◊ò◊†◊ì◊®◊ò.",
                    created_at: "2024-01-15T09:32:00Z", author: "Dr. Rachel Cohen"
                },
                {
                    id: 3, task_id: 1, run_id: 1,
                    content: "◊ñ◊ô◊î◊ô◊™◊ô ◊°◊ò◊ô◊ô◊î ◊ß◊ú◊î ◊ë-280nm - ◊ô◊õ◊ï◊ú ◊ú◊î◊¢◊ô◊ì ◊¢◊ú ◊†◊ï◊õ◊ó◊ï◊™ ◊ó◊ï◊û◊¶◊î ◊ê◊°◊ß◊ï◊®◊ë◊ô◊™ ◊û◊ó◊ï◊û◊¶◊†◊™. ◊ì◊ï◊®◊© ◊ë◊ì◊ô◊ß◊î ◊†◊ï◊°◊§◊™.",
                    created_at: "2024-01-15T09:45:00Z", author: "Dr. Rachel Cohen"
                },
                
                // Task 1 - Run 2
                {
                    id: 4, task_id: 1, run_id: 2,
                    content: "◊ó◊ñ◊®◊î ◊¢◊ú ◊î◊û◊ì◊ô◊ì◊î ◊¢◊ù ◊ì◊í◊ô◊û◊î ◊ò◊®◊ô◊ô◊î. ◊î◊§◊¢◊ù ◊¢◊ù pH ◊û◊ë◊ï◊ß◊® ◊ë-3.5",
                    created_at: "2024-01-15T14:20:00Z", author: "Dan Levi"
                },
                {
                    id: 5, task_id: 1, run_id: 2,
                    content: "◊™◊ï◊¶◊ê◊ï◊™ ◊û◊¢◊ï◊ú◊ï◊™! ◊®◊ô◊õ◊ï◊ñ ◊ï◊ô◊ò◊û◊ô◊ü C: 44.1mg/100ml. ◊¢◊ß◊ï◊û◊î ◊ó◊ú◊ß◊î ◊ú◊ú◊ê ◊î◊§◊®◊¢◊ï◊™.",
                    created_at: "2024-01-15T14:35:00Z", author: "Dan Levi"
                },
                
                // Task 2 (Chlorophyll Analysis) - Run 1
                {
                    id: 6, task_id: 2, run_id: 1,
                    content: "◊û◊ì◊ô◊ì◊™ ◊õ◊ú◊ï◊®◊ï◊§◊ô◊ú ◊ë◊¢◊ú◊ô ◊™◊®◊ì. ◊ì◊í◊ô◊û◊î ◊î◊ï◊û◊ï◊í◊†◊ô◊™ ◊ë◊ê◊™◊†◊ï◊ú 80%",
                    created_at: "2024-01-16T08:30:00Z", author: "Miri Even"
                },
                {
                    id: 7, task_id: 2, run_id: 1,
                    content: "◊©◊ô◊ê ◊ê◊ë◊°◊§◊ï◊®◊¶◊ô◊î ◊ë-663nm (◊õ◊ú◊ï◊®◊ï◊§◊ô◊ú a) ◊ï-647nm (◊õ◊ú◊ï◊®◊ï◊§◊ô◊ú b). ◊ô◊ó◊° a/b = 2.8 - ◊™◊ß◊ô◊ü ◊ú◊¢◊ú◊ô ◊™◊®◊ì",
                    created_at: "2024-01-16T08:50:00Z", author: "Miri Even"
                },
                {
                    id: 8, task_id: 2, run_id: 1,
                    content: "◊®◊ô◊õ◊ï◊ñ ◊õ◊ï◊ú◊ú: ◊õ◊ú◊ï◊®◊ï◊§◊ô◊ú a = 1.23mg/g, ◊õ◊ú◊ï◊®◊ï◊§◊ô◊ú b = 0.44mg/g. ◊™◊ï◊¶◊ê◊ï◊™ ◊™◊ï◊ê◊û◊ï◊™ ◊°◊§◊®◊ï◊™ ◊û◊ß◊¶◊ï◊¢◊ô◊™.",
                    created_at: "2024-01-16T09:15:00Z", author: "Dr. Rachel Cohen"
                },
                
                // Task 3 (Water Purity Testing) - Run 1
                {
                    id: 9, task_id: 3, run_id: 1,
                    content: "◊ë◊ì◊ô◊ß◊™ ◊ò◊ï◊î◊® ◊û◊ô◊ù ◊û◊ë◊®◊ñ ◊û◊¢◊ë◊ì◊î. ◊û◊ì◊ô◊ì◊î ◊ë-254nm ◊ú◊ñ◊ô◊î◊ï◊ô ◊ó◊ï◊û◊®◊ô◊ù ◊ê◊ï◊®◊í◊†◊ô◊ô◊ù",
                    created_at: "2024-01-17T11:00:00Z", author: "Dan Levi"
                },
                {
                    id: 10, task_id: 3, run_id: 1,
                    content: "◊ê◊ë◊°◊§◊ï◊®◊ë◊ô◊ï◊™ ◊†◊û◊ï◊õ◊î ◊û◊ê◊ï◊ì < 0.05 ◊ë◊õ◊ú ◊î◊ò◊ï◊ï◊ó. ◊û◊ô◊ù ◊¢◊ï◊û◊ì◊ô◊ù ◊ë◊™◊ß◊ü ◊ê◊ô◊õ◊ï◊™ ◊ú◊û◊¢◊ë◊ì◊î.",
                    created_at: "2024-01-17T11:25:00Z", author: "Dan Levi"
                }
            ];
            let nextNoteId = 11;

            // Save a new note or update an existing one
            async function saveNote() {
                if (!currentTaskId || currentRunId === null) {
                    alert('Please select a run first');
                    return;
                }
                
                const noteText = document.getElementById('note-text').value.trim();
                
                if (!noteText) {
                    alert('Please enter some text for your note');
                    return;
                }
                
                if (noteText.length > 10000) {
                    alert('Note is too long. Please keep notes under 10,000 characters.');
                    return;
                }
                
                // Disable form while saving
                const saveBtn = document.getElementById('save-note-btn');
                const cancelBtn = document.getElementById('cancel-note-btn');
                const textarea = document.getElementById('note-text');
                
                saveBtn.disabled = true;
                cancelBtn.disabled = true;
                textarea.disabled = true;
                saveBtn.textContent = 'Saving...';
                
                try {
                    // Try server first, fallback to mock data
                    let success = false;
                    
                    try {
                        let url, method;
                        
                        if (currentEditingNoteId) {
                            // Update existing note
                            url = `http://localhost:8000/api/notes/${currentEditingNoteId}`;
                            method = 'PUT';
                        } else {
                            // Create new note
                            url = `http://localhost:8000/api/tasks/${currentTaskId}/runs/${currentRunId}/notes`;
                            method = 'POST';
                        }
                        
                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                task_id: currentTaskId,
                                run_id: currentRunId,
                                content: noteText
                            })
                        });
                        
                        if (response.ok) {
                            success = true;
                        }
                    } catch (serverError) {
                        console.log('Server not available, using mock data');
                    }
                    
                    // If server failed, use mock data
                    if (!success) {
                        if (currentEditingNoteId) {
                            // Update existing note in mock data
                            const noteIndex = mockNotes.findIndex(n => n.id === currentEditingNoteId);
                            if (noteIndex >= 0) {
                                mockNotes[noteIndex].content = noteText;
                                mockNotes[noteIndex].created_at = new Date().toISOString();
                            }
                        } else {
                            // Add new note to mock data
                            const newNote = {
                                id: nextNoteId++,
                                task_id: currentTaskId,
                                run_id: currentRunId,
                                content: noteText,
                                created_at: new Date().toISOString(),
                                author: "Current User"
                            };
                            mockNotes.push(newNote);
                        }
                    }
                    
                    // Hide the form
                    document.getElementById('note-form').style.display = 'none';
                    currentEditingNoteId = null;
                    
                    // Reload notes
                    loadRunNotes(currentTaskId, currentRunId);
                    
                    // Update note count in the run card
                    updateRunNoteCount(currentTaskId, currentRunId);
                    
                    // Show success message
                    showNotification(currentEditingNoteId ? 'Note updated successfully' : 'Note added successfully', 'success');
                } catch (error) {
                    console.error('Error saving note:', error);
                    showNotification(`Error: ${error.message}`, 'error');
                } finally {
                    // Re-enable form
                    saveBtn.disabled = false;
                    cancelBtn.disabled = false;
                    textarea.disabled = false;
                    saveBtn.textContent = 'Save Note';
                }
            }
            
            // Update note count in run card
            async function updateRunNoteCount(taskId, runId) {
                try {
                    let noteCount = 0;
                    
                    // Try server first
                    try {
                        const response = await fetch(`http://localhost:8000/api/tasks/${taskId}/runs/${runId}/notes`);
                        if (response.ok) {
                            const notes = await response.json();
                            noteCount = notes.length;
                        } else {
                            throw new Error('Server not available');
                        }
                    } catch (serverError) {
                        // Use mock data as fallback
                        noteCount = mockNotes.filter(note => 
                            note.task_id == taskId && note.run_id == runId
                        ).length;
                    }
                    
                    const runCard = document.querySelector(`.run-card[data-task-id="${taskId}"][data-run-id="${runId}"]`);
                    if (runCard) {
                        const notesCountEl = runCard.querySelector('.run-notes-count');
                        if (notesCountEl) {
                            notesCountEl.innerHTML = `
                                <i class="fas fa-sticky-note"></i> 
                                ${noteCount === 0 ? 'No notes' : 
                                  noteCount === 1 ? '1 note' : 
                                  `${noteCount} notes`}
                            `;
                        }
                    }
                    
                    // Update in tasksData
                    const taskData = tasksData.find(t => t.task_id == taskId);
                    if (taskData) {
                        const runData = taskData.runs.find(r => r.run_id == runId);
                        if (runData) {
                            runData.notes_count = noteCount;
                        }
                    }
                } catch (error) {
                    console.error(`Error updating note count for run ${runId}:`, error);
                }
            }
            
            // Delete a note
            async function deleteNote(noteId) {
                if (!confirm('Are you sure you want to delete this note?')) {
                    return;
                }
                
                const noteCard = document.querySelector(`.note-card[data-note-id="${noteId}"]`);
                if (noteCard) {
                    noteCard.style.opacity = '0.5';
                    const deleteBtn = noteCard.querySelector('.delete-note');
                    if (deleteBtn) {
                        deleteBtn.disabled = true;
                        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                    }
                }
                
                try {
                    const response = await fetch(`http://localhost:8000/api/notes/${noteId}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Server error (${response.status}): ${errorText}`);
                    }
                    
                    // Reload notes
                    loadRunNotes(currentTaskId, currentRunId);
                    
                    // Update note count in the run card
                    updateRunNoteCount(currentTaskId, currentRunId);
                    
                    // Show success message
                    showNotification('Note deleted successfully', 'success');
                } catch (error) {
                    console.error('Error deleting note:', error);
                    showNotification(`Error: ${error.message}`, 'error');
                    
                    // Restore the note card if it failed
                    if (noteCard) {
                        noteCard.style.opacity = '1';
                        const deleteBtn = noteCard.querySelector('.delete-note');
                        if (deleteBtn) {
                            deleteBtn.disabled = false;
                            deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
                        }
                    }
                }
            }
            
            // Function to show notifications
            function showNotification(message, type = 'info') {
                let notificationContainer = document.querySelector('.notification-container');
                
                if (!notificationContainer) {
                    notificationContainer = document.createElement('div');
                    notificationContainer.className = 'notification-container';
                    document.body.appendChild(notificationContainer);
                }
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <span>${message}</span>
                    <button class="close-notification">&times;</button>
                `;
                
                notificationContainer.appendChild(notification);
                
                notification.querySelector('.close-notification').addEventListener('click', () => {
                    notification.remove();
                });
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 5000);
            }
            
            // Edit run name function
            async function editRunName(spanElement, taskId, runId) {
                const currentName = spanElement.textContent;
                
                // Create input element
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentName;
                input.className = 'run-name-input';
                input.style.cssText = `
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid #4facfe;
                    border-radius: 4px;
                    color: white;
                    padding: 2px 6px;
                    font-size: 14px;
                    font-weight: 600;
                    width: 80px;
                    outline: none;
                `;
                
                // Replace span with input
                spanElement.style.display = 'none';
                spanElement.parentNode.insertBefore(input, spanElement);
                input.focus();
                input.select();
                
                // Save function
                const saveEdit = async () => {
                    const newName = input.value.trim();
                    if (newName && newName !== currentName) {
                        try {
                            // Store custom run name in localStorage
                            const storageKey = `run_name_${taskId}_${runId}`;
                            localStorage.setItem(storageKey, newName);
                            
                            spanElement.textContent = newName;
                            showSuccessMessage('Run name updated successfully');
                        } catch (error) {
                            console.error('Error updating run name:', error);
                            showErrorMessage('Failed to update run name');
                        }
                    }
                    
                    // Restore span
                    input.remove();
                    spanElement.style.display = '';
                };
                
                // Cancel function
                const cancelEdit = () => {
                    input.remove();
                    spanElement.style.display = '';
                };
                
                // Event listeners
                input.addEventListener('blur', saveEdit);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveEdit();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelEdit();
                    }
                });
            }
            
            // Function to get custom run name from localStorage
            function getCustomRunName(taskId, runId) {
                const storageKey = `run_name_${taskId}_${runId}`;
                const customName = localStorage.getItem(storageKey);
                return customName || `Run #${runId}`;
            }
            
            // Delete run function
            async function deleteRun(taskId, runId, cardElement) {
                const runName = getCustomRunName(taskId, runId);
                
                if (!confirm(`Are you sure you want to delete ${runName}?\n\nThis action cannot be undone and will remove all measurement data and notes for this run.`)) {
                    return;
                }
                
                try {
                    showLoadingMessage('Deleting run...');
                    
                    // For now, since there's no server endpoint to delete runs,
                    // we'll just remove it from the UI and localStorage
                    
                    // Remove custom name from localStorage
                    const storageKey = `run_name_${taskId}_${runId}`;
                    localStorage.removeItem(storageKey);
                    
                    // Remove the card from UI with animation
                    cardElement.style.transition = 'all 0.3s ease';
                    cardElement.style.transform = 'scale(0.8)';
                    cardElement.style.opacity = '0';
                    
                    setTimeout(() => {
                        cardElement.remove();
                        showSuccessMessage(`${runName} deleted successfully`);
                        
                        // Check if task section is now empty
                        const taskSection = cardElement.closest('.tasks-section');
                        if (taskSection) {
                            const remainingRuns = taskSection.querySelectorAll('.run-card');
                            if (remainingRuns.length === 0) {
                                taskSection.style.display = 'none';
                            }
                        }
                    }, 300);
                    
                } catch (error) {
                    console.error('Error deleting run:', error);
                    showErrorMessage('Failed to delete run');
                }
            }
            
            // Show loading message
            function showLoadingMessage(message) {
                console.log('Loading:', message);
                // You can implement a loading toast here
            }
            
            // Show success message
            function showSuccessMessage(message) {
                // You can implement a toast notification here
                console.log('Success:', message);
            }
            
            // Show error message
            function showErrorMessage(message) {
                // You can implement a toast notification here
                console.error('Error:', message);
                alert(message); // Simple alert for now
            }
        })(); // End of IIFE
        
        // Also try to load data immediately in case DOMContentLoaded already fired
        console.log('üîÑ Notes page script loaded, attempting immediate data load...');
        setTimeout(() => {
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                console.log('üîÑ Document ready, loading data...');
                // Find the loadAllData function in the IIFE scope and call it
                const loadDataEvent = new Event('notesPageReady');
                document.dispatchEvent(loadDataEvent);
            }
        }, 100);
    </script>
</div> 
</div> 